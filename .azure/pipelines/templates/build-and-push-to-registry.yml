parameters:
  - name: AppInsightsKey
    # description: 'Key for AppInsights integration'
  - name: BranchName
    # description: 'Name of the git branch, will be used as part of the image tag'
  - name: Environment
    # description: 'Destination environemnt'

steps:
  - task: CmdLine@2
    displayName: Generate Commit Short SHA
    inputs:
      script: ' x=`echo "$(Build.SourceVersion)" | head -c 7`; echo "##vso[task.setvariable variable=ShortSha]$x"'

  - task: Docker@2
    displayName: Build an image
    inputs:
      command: build
      containerRegistry: chessstats
      repository: ${{ parameters.Environment }}/${{ parameters.BranchName }}
      arguments: '--build-arg APP_INSIGHTS_KEY=${{ parameters.AppInsightsKey }} --build-arg APP_VERSION=${{ parameters.BranchName }}--$(ShortSha)'
      tags: |
        ${{ parameters.BranchName }}--$(ShortSha)
        latest

  - task: Docker@2
    displayName: Push an image
    inputs:
      containerRegistry: chessstats
      repository: ${{ parameters.Environment }}/${{ parameters.BranchName }}
      command: push
      tags: |
        ${{ parameters.BranchName }}--$(ShortSha)
        latest
