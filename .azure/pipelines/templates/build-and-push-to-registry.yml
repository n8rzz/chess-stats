parameters:
  - name: AppInsightsKey
  - name: BranchName
  - name: EnvFileName
  - name: Repository
  - name: Registry

steps:
  - task: DownloadSecureFile@1
    name: env
    displayName: 'Download ENV'
    inputs:
      secureFile: ${{ parameters.EnvFileName }}

  - bash: |
      touch env
      cat "$(env.secureFilePath)" >> env
    displayName: Set environment file

  - task: CmdLine@2
    displayName: Generate Commit Short SHA
    inputs:
      script: ' x=`echo "$(Build.SourceVersion)" | head -c 7`; echo "##vso[task.setvariable variable=ShortSha]$x"'

  - task: Docker@2
    displayName: Build an image
    inputs:
      command: build
      containerRegistry: ${{ parameters.Registry }}
      buildContext: ./
      repository: ${{ parameters.Repository }}/${{ parameters.BranchName }}
      arguments: '--build-arg APP_INSIGHTS_KEY=${{ parameters.AppInsightsKey }} --build-arg APP_VERSION=${{ parameters.BranchName }}--$(ShortSha)'
      tags: |
        ${{ parameters.BranchName }}--$(ShortSha)
        latest

  - task: Docker@2
    displayName: Push an image
    inputs:
      containerRegistry: ${{ parameters.Registry }}
      repository: ${{ parameters.Repository }}/${{ parameters.BranchName }}
      command: push
      tags: |
        ${{ parameters.BranchName }}--$(ShortSha)
        latest
